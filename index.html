<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Football Arena Online</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        :root {
            --neon: #00ff66;
            --bg: #050706;
            --card: rgba(20, 25, 22, 0.95);
            --border: rgba(0, 255, 102, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; text-transform: uppercase; }
        body { background-color: var(--bg); color: #fff; height: 100vh; overflow: hidden; }

        .app-container { width: 100%; max-width: 500px; height: 100vh; margin: 0 auto; display: flex; flex-direction: column; position: relative; }

        /* HEADER */
        .header { padding: 15px 20px; display: flex; justify-content: flex-end; }
        .balance-pill { background: #000; padding: 10px 18px; border-radius: 50px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; box-shadow: 0 0 20px rgba(0,255,102,0.1); }
        .ton-logo { width: 20px; height: 20px; }

        /* SCROLL CONTENT */
        .main-scroll { flex: 1; padding: 0 20px; overflow-y: auto; padding-bottom: 110px; scrollbar-width: none; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* PROFILE */
        .profile-section { text-align: center; margin: 20px 0; }
        .avatar-frame { width: 110px; height: 110px; margin: 0 auto 15px; border-radius: 50%; border: 4px solid var(--neon); padding: 5px; box-shadow: 0 0 25px rgba(0,255,102,0.2); }
        .avatar-frame img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .nick { font-size: 26px; letter-spacing: -1px; }

        /* STADIUM */
        .bank-info { text-align: center; margin-bottom: 12px; font-size: 14px; color: var(--neon); font-weight: 800; }
        .stadium {
            width: 100%; aspect-ratio: 1/1.3; background: #080a09; border: 3px solid #1a221e; border-radius: 20px;
            position: relative; overflow: hidden; display: flex; flex-direction: column; box-shadow: inset 0 0 50px #000;
        }

        .territory {
            width: 100%; transition: height 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; display: flex; align-items: center; justify-content: center;
        }
        .t-avatar { width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 5; }

        /* BALL & ARROW */
        #ball {
            position: absolute; width: 22px; height: 22px; background: #fff; border-radius: 50%;
            left: 50%; top: 50%; transform: translate(-50%, -50%);
            border: 2px solid #000; box-shadow: 0 0 20px #fff; z-index: 100; display: none;
        }
        #arrow {
            position: absolute; width: 45px; height: 4px; background: #fff; border: 1px solid #000;
            left: 50%; top: 50%; transform-origin: left center; border-radius: 10px;
            z-index: 90; display: none; box-shadow: 0 0 10px #fff;
        }

        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.7);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 110; text-align: center; padding: 20px;
        }

        /* BETTING */
        .bet-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .bet-btn { 
            background: var(--card); border: 1px solid var(--border); color: #fff; 
            padding: 12px; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.2s;
        }
        .bet-btn:active { transform: scale(0.95); background: var(--neon); color: #000; }
        .bet-btn:disabled { opacity: 0.4; pointer-events: none; }

        /* PANEL */
        .players-panel { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .player-card {
            background: var(--card); border-radius: 15px; padding: 10px;
            display: flex; align-items: center; gap: 10px; border-left: 4px solid transparent;
        }
        .p-info b { font-size: 11px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80px; }
        .p-info span { font-size: 10px; color: var(--neon); }

        /* NAV */
        .nav-dock { position: fixed; bottom: 20px; left: 20px; right: 20px; height: 75px; background: rgba(5,7,6,0.9); border-radius: 40px; display: flex; align-items: center; border: 1px solid var(--border); backdrop-filter: blur(10px); }
        .nav-link { flex: 1; text-align: center; color: #4a554f; text-decoration: none; font-size: 10px; display: flex; flex-direction: column; align-items: center; background: none; border: none; font-weight: 800; }
        .nav-link i { font-size: 22px; margin-bottom: 5px; }
        .nav-link.active { color: var(--neon); }
    </style>
</head>
<body>

<div class="app-container">
    <header class="header">
        <div class="balance-pill">
            <img src="https://cryptologos.cc/logos/toncoin-ton-logo.png" class="ton-logo">
            <span id="bal-val">10.00</span>
        </div>
    </header>

    <main class="main-scroll">
        <section id="profile" class="page active">
            <div class="profile-section">
                <div class="avatar-frame"><img src="" id="user-ava"></div>
                <h1 class="nick" id="user-nick">ИГРОК</h1>
                <p id="user-username" style="color:var(--neon); font-size:12px; margin-top:5px;">@username</p>
            </div>
            <div style="background:var(--card); padding:20px; border-radius:20px; border:1px solid var(--border); text-align:center;">
                <p style="color:#777; font-size:10px;">ВАШ БАЛАНС</p>
                <h2 id="prof-bal" style="font-size:32px;">10.00 TON</h2>
            </div>
        </section>

        <section id="arena" class="page">
            <div class="bank-info">ОБЩИЙ БАНК: <span id="total-bank">0.00</span> TON</div>
            <div class="stadium" id="stadium">
                <div id="game-overlay" class="overlay">
                    <h2 id="status-txt">ОЖИДАНИЕ ИГРОКОВ</h2>
                    <div id="timer-box" style="font-size:36px; color:var(--neon); font-weight:900; margin-top:10px;"></div>
                </div>
                <div id="arrow"></div>
                <div id="ball"></div>
            </div>

            <div class="bet-buttons">
                <button class="bet-btn" onclick="makeBet(1)">+1 TON</button>
                <button class="bet-btn" onclick="makeBet(5)">+5 TON</button>
                <button class="bet-btn" onclick="makeBet(10)">+10 TON</button>
            </div>

            <div class="players-panel" id="player-list"></div>
        </section>
    </main>

    <nav class="nav-dock">
        <button class="nav-link" onclick="showPage('arena', this)"><i class="fa-solid fa-trophy"></i><span>АРЕНА</span></button>
        <button class="nav-link active" onclick="showPage('profile', this)"><i class="fa-solid fa-circle-user"></i><span>ПРОФИЛЬ</span></button>
    </nav>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const socket = io();
    let balance = parseFloat(localStorage.getItem('ton_bal')) || 10.00;

    const user = tg.initDataUnsafe.user || { first_name: "Игрок", username: "id" + Math.floor(Math.random()*9999), photo_url: "" };

    // Init UI
    document.getElementById('user-nick').innerText = user.first_name;
    document.getElementById('user-username').innerText = "@" + user.username;
    document.getElementById('user-ava').src = user.photo_url || `https://ui-avatars.com/api/?name=${user.first_name}&background=00ff66&color=000`;
    updateBal();

    function updateBal() {
        document.getElementById('bal-val').innerText = balance.toFixed(2);
        document.getElementById('prof-bal').innerText = balance.toFixed(2) + " TON";
        localStorage.setItem('ton_bal', balance);
    }

    function showPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        el.classList.add('active');
    }

    function makeBet(amt) {
        if (balance >= amt) {
            balance -= amt;
            updateBal();
            socket.emit('place_bet', {
                name: user.first_name,
                username: user.username,
                avatar: user.photo_url || `https://ui-avatars.com/api/?name=${user.first_name}`,
                amount: amt
            });
            tg.HapticFeedback.impactOccurred('medium');
        } else {
            tg.showAlert("Недостаточно TON!");
        }
    }

    socket.on('init_state', (state) => updateArena(state));
    socket.on('update_arena', (state) => updateArena(state));

    function updateArena(state) {
        const stadium = document.getElementById('stadium');
        const list = document.getElementById('player-list');
        const overlay = document.getElementById('game-overlay');
        
        document.getElementById('total-bank').innerText = state.totalBank.toFixed(2);
        
        // Clear territories except ball/arrow/overlay
        document.querySelectorAll('.territory').forEach(t => t.remove());
        list.innerHTML = '';

        if (state.status === 'playing') {
            document.querySelectorAll('.bet-btn').forEach(b => b.disabled = true);
        } else {
            document.querySelectorAll('.bet-btn').forEach(b => b.disabled = false);
            overlay.style.display = state.players.length >= 2 ? 'flex' : (state.players.length > 0 ? 'flex' : 'flex');
            
            if (state.players.length === 0) {
                document.getElementById('status-txt').innerText = "ОЖИДАНИЕ ИГРОКОВ";
                document.getElementById('timer-box').innerText = "";
            } else if (state.players.length === 1) {
                document.getElementById('status-txt').innerText = "НУЖЕН СОПЕРНИК";
                document.getElementById('timer-box').innerText = "";
            }
        }

        state.players.forEach(p => {
            // Territory
            const t = document.createElement('div');
            t.className = 'territory';
            t.id = 'zone-' + p.username;
            t.style.height = (p.amount / state.totalBank * 100) + '%';
            t.style.backgroundColor = p.color;
            t.innerHTML = `<img src="${p.avatar}" class="t-avatar">`;
            stadium.appendChild(t);

            // Card
            list.innerHTML += `
                <div class="player-card" style="border-left-color:${p.color}">
                    <img src="${p.avatar}" style="width:30px;height:30px;border-radius:50%">
                    <div class="p-info"><b>@${p.username}</b><span>${p.chance}%</span></div>
                </div>`;
        });
    }

    socket.on('timer_tick', (sec) => {
        document.getElementById('status-txt').innerText = "МАТЧ НАЧНЕТСЯ";
        document.getElementById('timer-box').innerText = sec + "с";
    });

    socket.on('start_game_animation', (data) => {
        const ball = document.getElementById('ball');
        const arrow = document.getElementById('arrow');
        const overlay = document.getElementById('game-overlay');
        
        overlay.style.display = 'none';
        ball.style.display = 'block';
        ball.style.left = '50%'; ball.style.top = '50%';
        ball.style.transition = 'none';

        setTimeout(() => {
            arrow.style.display = 'block';
            let angle = 0;
            const rotate = setInterval(() => { 
                angle += 15; 
                arrow.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`; 
            }, 30);

            setTimeout(() => {
                clearInterval(rotate);
                arrow.style.display = 'none';
                
                // PHYSICS FLIGHT
                let posX = stadium.clientWidth / 2;
                let posY = stadium.clientHeight / 2;
                let vx = (Math.random() - 0.5) * 15;
                let vy = (Math.random() - 0.5) * 15;
                let duration = 10000; // 10 sec flight
                let start = Date.now();

                function animate() {
                    let now = Date.now();
                    let elapsed = now - start;

                    if (elapsed < duration) {
                        posX += vx; posY += vy;
                        
                        // Bounce walls
                        if (posX < 15 || posX > stadium.clientWidth - 15) vx *= -1;
                        if (posY < 15 || posY > stadium.clientHeight - 15) vy *= -1;

                        // Slow down slightly at the end to target
                        if (elapsed > duration - 2000) {
                            const zone = document.getElementById('zone-' + data.winner.username);
                            const targetY = zone.offsetTop + zone.clientHeight / 2;
                            vy += (targetY - posY) * 0.05;
                            vx *= 0.98; // Stop horizontal
                        }

                        ball.style.left = posX + 'px';
                        ball.style.top = posY + 'px';
                        requestAnimationFrame(animate);
                    } else {
                        // Finish
                        overlay.style.display = 'flex';
                        document.getElementById('status-txt').innerHTML = `<span style="font-size:14px;color:#fff">ПОБЕДИТЕЛЬ:</span><br><span style="color:${data.winner.color}">@${data.winner.username}</span>`;
                        document.getElementById('timer-box').innerText = "";
                        tg.HapticFeedback.notificationOccurred('success');
                        
                        if (data.winner.username === user.username) {
                            balance += parseFloat(document.getElementById('total-bank').innerText);
                            updateBal();
                        }
                    }
                }
                animate();
            }, 3000);
        }, 2000);
    });
</script>
</body>
</html>
